# JuJ Hub - Windows Server 2012部署教程

本文档提供了将JuJ Hub网站部署到Windows Server 2012服务器的详细步骤，特别针对非专业程序员优化内容，尽量避免使用复杂术语。

## 基础概念简介

在开始部署前，了解一些基本概念会有所帮助：

* **Node.js**: 一个让JavaScript可以在服务器上运行的软件平台
* **npm**: Node.js的包管理器，用于安装和管理JavaScript程序包
* **Git**: 版本控制软件，用于管理和跟踪代码变更
* **IIS**: Windows的网页服务器(Internet Information Services)，负责向用户展示网站
* **HTTPS**: 加密的网页传输协议，提供安全连接
* **PM2**: Node.js应用程序的进程管理器，确保网站持续运行
* **反向代理**: 将用户的请求转发到内部服务器处理的一种技术

## 目录

1. [环境准备](#1-环境准备)
2. [代码部署](#2-代码部署)
3. [持久化运行设置](#3-持久化运行设置)
4. [配置IIS反向代理](#4-配置iis反向代理)
5. [配置HTTPS](#5-配置https)
6. [防火墙配置](#6-防火墙配置)
7. [日志和监控](#7-日志和监控)
8. [测试部署](#8-测试部署)
9. [一键部署脚本](#9-一键部署脚本)
10. [常见问题](#10-常见问题)

## 1. 环境准备

这一步骤将在服务器上安装所需的基本软件。

### 如何打开PowerShell并以管理员身份运行

1. 点击Windows开始菜单
2. 搜索"PowerShell"
3. 右键点击"Windows PowerShell"，选择"以管理员身份运行"
4. 看到蓝色窗口弹出后，就可以输入命令了

### 安装Node.js与npm

Node.js是运行JuJ Hub网站的基础环境。以下步骤会下载并安装Node.js：

```powershell
# 下载Node.js LTS版本(适用于Windows Server 2012)
# 这条命令会从官网下载Node.js安装包到C盘根目录
Invoke-WebRequest -Uri https://nodejs.org/dist/v16.20.2/node-v16.20.2-x64.msi -OutFile C:\node-setup.msi

# 安装Node.js
# 这条命令会静默安装Node.js，不会弹出安装向导
Start-Process -FilePath "msiexec.exe" -ArgumentList "/i C:\node-setup.msi /quiet /norestart" -Wait

# 验证安装
# 这两条命令会显示安装的版本号，确认安装成功
node --version
npm --version
```

> 注意：如果命令执行后没有显示版本号，可能需要重新打开PowerShell窗口或重启服务器。

### 安装Git(用于代码部署)

Git用于获取和管理JuJ Hub的源代码：

```powershell
# 下载Git
# 这条命令会从官网下载Git安装包到C盘根目录
Invoke-WebRequest -Uri https://github.com/git-for-windows/git/releases/download/v2.40.0.windows.1/Git-2.40.0-64-bit.exe -OutFile C:\git-setup.exe

# 安装Git
# 这条命令会静默安装Git，不会弹出安装向导
Start-Process -FilePath "C:\git-setup.exe" -ArgumentList "/VERYSILENT /NORESTART" -Wait

# 验证安装
# 这条命令会显示Git版本号，确认安装成功
git --version
```

## 2. 代码部署

这一步骤将获取JuJ Hub的源代码并进行基本配置。

### 获取代码

有两种方式获取代码：从Git仓库克隆或手动复制。

#### 方式一：使用Git克隆（推荐）

```powershell
# 创建部署目录
# 这两条命令会创建一个新的文件夹存放网站文件，然后进入该文件夹
mkdir C:\websites\jujhub
cd C:\websites\jujhub

# 克隆代码
# 将[你的仓库URL]替换为实际的Git仓库地址
git clone [你的仓库URL] .
```

> 注意：如果使用私有仓库，需要配置Git凭据。可能会弹出窗口要求输入用户名和密码。

#### 方式二：手动复制文件

如果您已经有了JuJ Hub的源文件：

1. 在服务器上创建文件夹：`C:\websites\jujhub`
2. 将所有源文件复制到该文件夹中
3. 确保文件结构正确，根目录应该包含package.json文件

### 安装依赖并构建

安装项目所需的所有依赖包，并编译生成生产环境版本：

```powershell
# 进入项目目录
cd C:\websites\jujhub

# 安装依赖
# 这条命令会下载并安装项目所需的所有依赖包，可能需要几分钟
npm install

# 构建生产版本
# 这条命令会将项目编译为可部署的生产版本
npm run build
```

> 注意：构建过程可能需要几分钟时间。如果出现错误，请检查错误信息或咨询开发人员。

## 3. 持久化运行设置

这一步骤将确保JuJ Hub网站可以持续运行，即使关闭终端窗口或服务器重启后也能自动启动。

可以选择以下两种方式之一：

### 方式一：使用PM2管理应用(推荐)

PM2是一个功能强大的Node.js应用进程管理器，适合大多数情况：

```powershell
# 全局安装PM2
npm install -g pm2

# 创建PM2启动配置
# 这段代码会创建一个配置文件，指定如何运行JuJ Hub
@"
module.exports = {
  apps: [{
    name: 'jujhub',
    script: 'node_modules/next/dist/bin/next',
    args: 'start',
    cwd: 'C:/websites/jujhub',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
};
"@ | Out-File -FilePath C:\websites\jujhub\ecosystem.config.js -Encoding utf8

# 启动应用
pm2 start ecosystem.config.js

# 设置PM2开机自启
pm2 save
pm2 startup
# 复制并执行PM2输出的命令（会显示在控制台上）
```

#### PM2启动配置说明

上面创建的配置文件包含以下重要设置：
- `name`: 应用名称，用于标识
- `script`: 启动脚本路径
- `args`: 启动参数
- `cwd`: 工作目录
- `autorestart`: 自动重启（当应用崩溃时）
- `max_memory_restart`: 内存使用超过此值时自动重启
- `env`: 环境变量设置

### 方式二：设置Windows服务

如果您更习惯使用Windows服务管理方式：

```powershell
# 全局安装node-windows
npm install -g node-windows

# 在项目目录创建服务安装脚本
@"
const { Service } = require('node-windows');
const path = require('path');

const svc = new Service({
  name: 'JuJHub',
  description: 'JuJ Hub软件下载平台',
  script: path.join(process.cwd(), 'node_modules/next/dist/bin/next'),
  scriptOptions: 'start',
  workingDirectory: process.cwd(),
  env: [{
    name: "NODE_ENV",
    value: "production"
  },{
    name: "PORT",
    value: "3000"
  }]
});

svc.on('install', () => {
  svc.start();
  console.log('JuJHub服务已安装并启动');
});

svc.install();
"@ | Out-File -FilePath C:\websites\jujhub\install-service.js -Encoding utf8

# 安装依赖并创建服务
cd C:\websites\jujhub
npm install node-windows --save-dev
node install-service.js
```

完成后，您可以在Windows服务管理器中看到名为"JuJHub"的服务。您可以通过以下步骤查看：
1. 打开"运行"对话框（Win+R）
2. 输入"services.msc"并按回车
3. 在列表中查找"JuJHub"服务

## 4. 配置IIS反向代理

IIS反向代理允许通过常规网站地址访问JuJ Hub（如 http://your-domain.com），而不是直接使用端口号访问（如 http://your-domain.com:3000）。

### 安装必要的组件

需要先安装IIS的URL重写模块和应用程序请求路由模块：

```powershell
# 安装URL重写模块(如果未安装)
# 这条命令下载URL重写模块安装包
Invoke-WebRequest -Uri https://download.microsoft.com/download/1/2/8/128E2E22-C1B9-44A4-BE2A-5859ED1D4592/rewrite_amd64_en-US.msi -OutFile C:\rewrite.msi
# 这条命令安装URL重写模块
Start-Process -FilePath "msiexec.exe" -ArgumentList "/i C:\rewrite.msi /quiet /norestart" -Wait

# 安装ARR(应用程序请求路由)模块
# 这条命令下载ARR模块安装包
Invoke-WebRequest -Uri https://download.microsoft.com/download/E/9/8/E9849D6A-020E-47E4-9FD0-A023E99B54EB/requestRouter_amd64.msi -OutFile C:\arr.msi
# 这条命令安装ARR模块
Start-Process -FilePath "msiexec.exe" -ArgumentList "/i C:\arr.msi /quiet /norestart" -Wait
```

### 手动IIS配置方法（图形界面）

如果您不熟悉PowerShell命令，可以使用图形界面配置：

1. 打开"服务器管理器"
2. 点击"工具" > "Internet Information Services (IIS)管理器"
3. 在左侧树形导航中展开服务器名称
4. 右键点击"网站"，选择"添加网站"
5. 填写以下信息：
   - 网站名称：JuJHub
   - 物理路径：C:\inetpub\wwwroot\jujhub
   - 绑定：选择HTTP，端口80，主机名填写您的域名
6. 点击"确定"创建网站

### 配置IIS网站（PowerShell方式）

如果您习惯使用命令行，可以使用PowerShell配置：

```powershell
# 导入IIS管理模块
Import-Module WebAdministration

# 创建应用程序池
# 这条命令创建一个新的应用程序池，用于运行JuJ Hub网站
New-WebAppPool -Name "JuJHubPool"
# 这条命令将应用程序池设置为不使用.NET运行时
Set-ItemProperty "IIS:\AppPools\JuJHubPool" -Name "managedRuntimeVersion" -Value ""

# 创建网站
# 这条命令创建一个新的IIS网站
New-Website -Name "JuJHub" -PhysicalPath "C:\inetpub\wwwroot\jujhub" -ApplicationPool "JuJHubPool" -Port 80 -HostHeader "your-domain.com"

# 创建物理路径(如果不存在)
# 这条命令创建网站的物理目录
New-Item -ItemType Directory -Path "C:\inetpub\wwwroot\jujhub" -Force

# 创建web.config文件
# 这段代码创建web.config配置文件，设置URL重写规则
@"
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="ReverseProxyInboundRule1" stopProcessing="true">
          <match url="(.*)" />
          <action type="Rewrite" url="http://localhost:3000/{R:1}" />
        </rule>
      </rules>
    </rewrite>
    <httpErrors existingResponse="PassThrough" />
    <security>
      <requestFiltering removeServerHeader="true" />
    </security>
    <httpProtocol>
      <customHeaders>
        <remove name="X-Powered-By" />
        <remove name="Server" />
      </customHeaders>
    </httpProtocol>
  </system.webServer>
</configuration>
"@ | Out-File -FilePath "C:\inetpub\wwwroot\jujhub\web.config" -Encoding utf8
```

### web.config文件详解

创建的web.config文件包含以下主要功能：
- URL重写规则：将所有请求转发到本地3000端口（Node.js应用运行的端口）
- 安全设置：移除服务器标识信息，提高安全性
- HTTP错误处理：允许Next.js应用自己处理错误

## 5. 配置HTTPS

HTTPS可以加密网站流量，提高安全性，同时对搜索引擎排名也有益处。

### 使用Let's Encrypt获取免费证书（推荐）

Let's Encrypt提供免费的HTTPS证书。在Windows上，可以使用Certify The Web工具：

```powershell
# 下载并安装Certify The Web
# 这条命令下载Certify The Web安装程序
Invoke-WebRequest -Uri https://certifytheweb.s3.amazonaws.com/downloads/archive/CertifyTheWebSetup_v5.8.2.exe -OutFile C:\certify-setup.exe
# 这条命令安装Certify The Web
Start-Process -FilePath "C:\certify-setup.exe" -ArgumentList "/VERYSILENT /NORESTART" -Wait
```

#### 使用Certify The Web申请证书的详细步骤：

1. 在Windows开始菜单中找到并打开"Certify The Web"
2. 点击"新建证书"按钮
3. 在"域名"字段中输入您的网站域名（例如：www.example.com）
4. 在"验证方式"下拉菜单中选择"HTTP验证"（最简单的方式）
5. 确保"自动部署到IIS"选项已勾选
6. 点击"请求证书"按钮
7. 等待证书申请和安装完成
8. 完成后，证书会自动应用到您的IIS网站

### 手动配置HTTPS绑定

如果您已经有了SSL证书，或使用其他方式获取了证书，可以手动配置：

```powershell
# 在获取证书后,添加HTTPS绑定
# 这条命令为JuJHub网站添加HTTPS绑定
New-WebBinding -Name "JuJHub" -Protocol "https" -Port 443 -HostHeader "your-domain.com" -SslFlags 1

# 将证书分配给绑定(需要证书指纹)
# 这两条命令查找证书并获取其指纹
$cert = Get-ChildItem -Path "Cert:\LocalMachine\My" | Where-Object {$_.Subject -like "*your-domain.com*"}
$certHash = $cert.Thumbprint

# 分配证书
# 这两条命令将证书分配给HTTPS绑定
$binding = Get-WebBinding -Name "JuJHub" -Protocol "https"
$binding.AddSslCertificate($certHash, "My")
```

### 配置HTTP重定向到HTTPS

为了安全起见，建议将所有HTTP请求重定向到HTTPS：

```powershell
# 在web.config中添加HTTP到HTTPS的重定向规则
@"
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="HTTP to HTTPS redirect" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" ignoreCase="true" />
          </conditions>
          <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
        </rule>
        <rule name="ReverseProxyInboundRule1" stopProcessing="true">
          <match url="(.*)" />
          <action type="Rewrite" url="http://localhost:3000/{R:1}" />
        </rule>
      </rules>
    </rewrite>
    <httpErrors existingResponse="PassThrough" />
    <security>
      <requestFiltering removeServerHeader="true" />
    </security>
    <httpProtocol>
      <customHeaders>
        <remove name="X-Powered-By" />
        <remove name="Server" />
      </customHeaders>
    </httpProtocol>
  </system.webServer>
</configuration>
"@ | Out-File -FilePath "C:\inetpub\wwwroot\jujhub\web.config" -Encoding utf8
```

这个新的web.config配置会：
1. 检测是否是HTTP请求
2. 如果是，则重定向到对应的HTTPS地址
3. 如果已经是HTTPS，则继续处理请求

## 6. 防火墙配置

服务器防火墙需要允许80端口(HTTP)和443端口(HTTPS)的访问：

```powershell
# 开放80和443端口
# 这条命令允许HTTP流量(80端口)通过防火墙
New-NetFirewallRule -DisplayName "Allow HTTP" -Direction Inbound -Protocol TCP -LocalPort 80 -Action Allow
# 这条命令允许HTTPS流量(443端口)通过防火墙
New-NetFirewallRule -DisplayName "Allow HTTPS" -Direction Inbound -Protocol TCP -LocalPort 443 -Action Allow
```

### 手动配置防火墙（图形界面）

如果您更习惯使用图形界面：

1. 打开"服务器管理器"
2. 点击"工具" > "高级安全Windows防火墙"
3. 在左侧选择"入站规则"
4. 在右侧点击"新建规则"
5. 选择"端口"并点击"下一步"
6. 选择"TCP"和"特定本地端口"，输入"80,443"
7. 点击"下一步"
8. 选择"允许连接"并点击"下一步"
9. 保持所有配置文件选中，点击"下一步"
10. 输入名称（如"JuJ Hub Web Traffic"）并点击"完成"

## 7. 日志和监控

日志对于排查问题和监控网站运行情况非常重要。

### 应用日志

设置应用日志可以帮助您追踪任何运行问题：

```powershell
# 创建日志目录
# 这条命令创建一个专门存放日志的目录
mkdir C:\websites\jujhub\logs

# 如果使用PM2，配置日志
# 这些命令安装并配置PM2的日志轮转功能，防止日志文件过大
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

### IIS日志配置（图形界面）

1. 打开IIS管理器
2. 在左侧树形菜单中选择JuJHub网站
3. 双击中间窗格中的"日志记录"图标
4. 在"目录"字段中，设置日志存储位置（如：C:\inetpub\logs\JuJHub）
5. 在"日志文件回滚"部分，选择"按大小回滚"并设置最大大小
6. 点击"应用"保存设置

## 8. 测试部署

完成所有配置后，应该测试网站是否正常工作。

### 本地测试

直接在服务器上测试网站：

1. 打开服务器上的Web浏览器
2. 访问地址：http://localhost:3000
3. 检查网站是否正常加载
4. 检查功能是否正常工作（如：搜索、下载等）

### 远程测试

从外部计算机测试网站：

1. 打开任意计算机上的Web浏览器
2. 访问您的网站域名：https://your-domain.com
3. 验证以下项目：
   - 网站是否正常加载
   - HTTPS是否正常工作（浏览器地址栏是否显示锁定图标）
   - 所有图片和资源是否正常显示
   - 功能是否正常工作

### 检查事项清单

确认以下项目都正常：

- [ ] 网站首页可以正常访问
- [ ] 所有图片正常显示
- [ ] 所有链接正常工作
- [ ] HTTPS证书有效（无安全警告）
- [ ] 搜索功能正常
- [ ] 软件下载功能正常
- [ ] 移动端布局正常

## 9. 一键部署脚本

为了简化将来的更新，可以创建一个一键部署脚本：

```powershell
# 创建部署脚本文件
@"
# 文件名: deploy.ps1
param (
    [string]$domain = "localhost",
    [int]$port = 3000
)

# 停止现有服务
if (Get-Service "JuJHub" -ErrorAction SilentlyContinue) {
    Write-Host "停止JuJHub服务..." -ForegroundColor Yellow
    Stop-Service "JuJHub"
} elseif (Get-Process "pm2" -ErrorAction SilentlyContinue) {
    Write-Host "停止PM2服务..." -ForegroundColor Yellow
    pm2 stop jujhub
}

# 备份当前版本
Write-Host "备份当前版本..." -ForegroundColor Yellow
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$backupDir = "C:\websites\jujhub_backup_$timestamp"
Copy-Item -Path "C:\websites\jujhub" -Destination $backupDir -Recurse -Force

# 拉取最新代码
Write-Host "拉取最新代码..." -ForegroundColor Yellow
cd C:\websites\jujhub
git pull

# 安装依赖
Write-Host "安装依赖..." -ForegroundColor Yellow
npm install

# 构建应用
Write-Host "构建应用..." -ForegroundColor Yellow
npm run build

# 重启服务
Write-Host "重启服务..." -ForegroundColor Yellow
if (Get-Service "JuJHub" -ErrorAction SilentlyContinue) {
    Start-Service "JuJHub"
} else {
    # 如果使用PM2
    pm2 restart jujhub || pm2 start ecosystem.config.js
}

Write-Host "部署完成! 网站可通过 https://$domain 访问" -ForegroundColor Green
"@ | Out-File -FilePath C:\websites\jujhub\deploy.ps1 -Encoding utf8
```

### 如何使用部署脚本

每次需要更新网站时，只需运行以下命令：

```powershell
# 打开PowerShell，切换到网站目录
cd C:\websites\jujhub

# 执行部署脚本，替换为您的实际域名
.\deploy.ps1 -domain "your-domain.com"
```

脚本会自动执行以下操作：
1. 停止当前运行的网站服务
2. 备份当前版本（以防万一需要回滚）
3. 下载最新代码
4. 安装依赖并重新构建
5. 重启服务

## 10. 常见问题

### 问题: 无法访问网站

**解决方案:**

1. 检查Node.js应用是否正在运行
   ```powershell
   # 查看3000端口是否有程序在监听
   netstat -ano | findstr "3000"
   ```
   如果没有结果，说明应用没有启动，检查：
   - 如果使用PM2：运行`pm2 list`查看应用状态
   - 如果使用Windows服务：检查服务是否启动

2. 检查IIS是否正常运行
   ```powershell
   # 查看IIS状态
   iisreset /status
   ```
   如果IIS没有运行，尝试启动：
   ```powershell
   iisreset /start
   ```

3. 检查防火墙规则
   - 打开"高级安全Windows防火墙"
   - 确认之前创建的规则处于"启用"状态
   - 如需临时测试，可以尝试完全关闭防火墙（不推荐长期）：
     ```powershell
     netsh advfirewall set allprofiles state off
     ```

4. 检查网站绑定
   - 打开IIS管理器
   - 选择JuJHub网站 > 右键 > 编辑绑定
   - 确认绑定的域名和IP地址正确

### 问题: HTTPS证书错误

**解决方案:**

1. 确认证书已正确安装
   - 打开IIS管理器
   - 选择JuJHub网站 > 右键 > 编辑绑定
   - 查看HTTPS绑定，确认证书已选择

2. 检查证书有效期
   ```powershell
   # 查看证书详细信息
   Get-ChildItem -Path "Cert:\LocalMachine\My" | Where-Object {$_.Subject -like "*your-domain.com*"} | Format-List
   ```
   检查NotAfter日期是否已过期

3. 重新申请证书
   - 如果使用Certify The Web：打开软件，选择证书，点击"Renew"
   - 如果手动申请：联系证书提供商获取新证书

### 问题: 网站加载缓慢

**解决方案:**

1. 检查Node.js应用性能
   如果使用PM2：
   ```powershell
   # 查看应用性能
   pm2 monit
   ```
   观察CPU和内存使用情况

2. 检查IIS缓存配置
   - 打开IIS管理器
   - 在服务器级别选择"输出缓存"
   - 为静态内容启用缓存

3. 优化应用
   - 在项目目录中是否有next.config.js文件，检查其中的性能优化选项
   - 检查图片资源是否已优化
   - 考虑使用CDN服务分发静态资源

---

## 附录: 有用的命令

### 服务管理命令

```powershell
# 检查端口占用
netstat -ano | findstr "3000"

# 重启IIS
iisreset

# 查看Windows服务状态
Get-Service "JuJHub"

# PM2常用命令
pm2 list                  # 查看所有应用
pm2 monit                 # 监控应用
pm2 logs                  # 查看日志
pm2 restart jujhub        # 重启应用
```

### 服务器维护命令

```powershell
# 查看磁盘空间
Get-PSDrive -PSProvider FileSystem

# 清理IIS日志(超过30天)
$logsPath = "C:\inetpub\logs\LogFiles"
Get-ChildItem -Path $logsPath -Recurse -File | Where-Object {$_.LastWriteTime -lt (Get-Date).AddDays(-30)} | Remove-Item

# 查看服务器内存使用
Get-Process | Sort-Object -Property WS -Descending | Select-Object -First 10 Name,WS

# 查看服务器CPU使用
Get-Process | Sort-Object -Property CPU -Descending | Select-Object -First 10 Name,CPU
```

### 常见错误代码解释

- **500**: 服务器内部错误，检查Node.js应用日志
- **502**: 网关错误，检查IIS与Node.js应用的连接
- **404**: 页面未找到，检查URL路径是否正确
- **403**: 禁止访问，检查文件权限

### 备份恢复步骤

1. 如果需要恢复到之前版本，找到备份文件夹(C:\websites\jujhub_backup_[时间戳])
2. 停止当前服务
3. 将备份文件夹内容复制回C:\websites\jujhub
4. 重启服务

---

希望本教程对您有所帮助！如有任何问题，请咨询您的技术支持人员。 
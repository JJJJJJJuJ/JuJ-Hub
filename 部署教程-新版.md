# JuJ Hub - Windows Server部署教程

本文档提供了在Windows Server上部署JuJ Hub软件下载平台的详细步骤，适合非专业程序员参考。

## 目录

1. [环境准备](#1-环境准备)
2. [代码部署](#2-代码部署)
3. [持久化运行设置](#3-持久化运行设置)
4. [配置访问方式](#4-配置访问方式)
   - [使用端口转发（推荐）](#使用端口转发推荐)
5. [配置HTTPS](#5-配置https)
6. [防火墙配置](#6-防火墙配置)
7. [测试部署](#7-测试部署)
8. [常见问题](#8-常见问题)

## 1. 环境准备

### 安装Node.js

```powershell
# 下载Node.js安装包
Invoke-WebRequest -Uri https://nodejs.org/dist/v18.17.1/node-v18.17.1-x64.msi -OutFile C:\node-setup.msi

# 安装Node.js
Start-Process -FilePath "msiexec.exe" -ArgumentList "/i C:\node-setup.msi /quiet /norestart" -Wait

# 验证安装
node --version  # 应显示v18.17.1或更高版本
npm --version
```

> 注意：JuJ Hub需要Node.js 18.x或更高版本。如果您已安装旧版本，请先卸载。

### 安装Git

```powershell
# 下载Git安装包
Invoke-WebRequest -Uri https://github.com/git-for-windows/git/releases/download/v2.40.0.windows.1/Git-2.40.0-64-bit.exe -OutFile C:\git-setup.exe

# 安装Git
Start-Process -FilePath "C:\git-setup.exe" -ArgumentList "/VERYSILENT /NORESTART" -Wait

# 验证安装
git --version
```

## 2. 代码部署

### 获取代码

```powershell
# 创建部署目录
mkdir C:\websites\jujhub
cd C:\websites\jujhub

# 克隆代码
git clone https://github.com/yourusername/JuJ-Hub.git JuJ-Hub
cd JuJ-Hub

# 安装依赖
npm install

# 构建生产版本
npm run build
```

## 3. 持久化运行设置

### 安装PM2

PM2是Node.js应用程序的进程管理器，可确保网站持续运行：

```powershell
# 全局安装PM2
npm install -g pm2

# 创建PM2配置文件
@"
module.exports = {
  apps: [{
    name: 'jujhub',
    script: 'node_modules/next/dist/bin/next',
    args: 'start',
    cwd: 'C:/websites/jujhub/JuJ-Hub',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
};
"@ | Out-File -FilePath C:\websites\jujhub\JuJ-Hub\ecosystem.config.js -Encoding utf8

# 启动应用
pm2 start ecosystem.config.js

# 保存PM2状态
pm2 save
```

## 4. 配置访问方式

### 使用端口转发（推荐）

端口转发是一种简单高效的方法，将80端口的请求转发到应用运行的3000端口。

#### 停止IIS服务

首先，需要停止IIS服务，释放80端口：

```powershell
# 停止IIS服务
iisreset /stop

# 禁用IIS自动启动
Set-Service -Name "W3SVC" -StartupType Disabled
```

#### 配置端口转发

```powershell
# 检查80端口是否已释放
netstat -ano | findstr ":80"

# 配置端口转发
netsh interface portproxy delete v4tov4 listenport=80 listenaddress=0.0.0.0
netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=3000 connectaddress=127.0.0.1

# 验证端口转发规则
netsh interface portproxy show all
```

#### 创建端口转发开机自启脚本

```powershell
# 创建批处理脚本
@"
@echo off
netsh interface portproxy delete v4tov4 listenport=80 listenaddress=0.0.0.0
netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=3000 connectaddress=127.0.0.1
"@ | Out-File -FilePath C:\websites\jujhub\portproxy-setup.bat -Encoding ascii

# 创建计划任务
$action = New-ScheduledTaskAction -Execute "C:\websites\jujhub\portproxy-setup.bat"
$trigger = New-ScheduledTaskTrigger -AtStartup
$principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
Register-ScheduledTask -TaskName "PortProxy-JuJHub" -Action $action -Trigger $trigger -Principal $principal
```

#### 创建PM2开机自启脚本

```powershell
# 创建PM2启动脚本
@"
@echo off
set PM2_HOME=C:\Users\Administrator\.pm2
cd /d C:\websites\jujhub\JuJ-Hub
pm2 resurrect
"@ | Out-File -FilePath C:\websites\jujhub\start-jujhub.bat -Encoding ascii

# 创建计划任务
$action = New-ScheduledTaskAction -Execute "C:\websites\jujhub\start-jujhub.bat"
$trigger = New-ScheduledTaskTrigger -AtStartup
$principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
Register-ScheduledTask -TaskName "PM2-JuJHub" -Action $action -Trigger $trigger -Principal $principal
```

## 5. 配置HTTPS

### 使用Certify The Web获取证书

1. 下载并安装Certify The Web：https://certifytheweb.com/download
2. 运行Certify The Web，点击"新建证书"
3. 添加您的域名（例如：jujcsgo.cn 和 www.jujcsgo.cn）
4. 在"Authorization"标签页中选择HTTP验证方式
5. 点击"请求证书"按钮获取证书

### 配置Next.js应用支持HTTPS

JuJ Hub提供了完整的HTTPS支持方案，包含以下关键文件：

- `https-server.js`: HTTPS服务器，在3001端口运行
- `http-server.js`: HTTP重定向服务器，将HTTP请求重定向到HTTPS
- `ecosystem-https.config.js`: PM2配置文件，同时运行HTTP和HTTPS服务
- `setup-https.ps1`: HTTPS配置脚本

执行以下步骤配置HTTPS：

```powershell
# 复制必要文件到项目目录
Copy-Item -Path "https-server.js" -Destination "C:\websites\jujhub\JuJ-Hub\https-server.js" -Force
Copy-Item -Path "ecosystem-https.config.js" -Destination "C:\websites\jujhub\JuJ-Hub\ecosystem-https.config.js" -Force

# 停止现有PM2服务
cd C:\websites\jujhub\JuJ-Hub
pm2 stop all

# 使用新配置启动服务
pm2 start ecosystem-https.config.js
pm2 save

# 配置端口转发（添加443端口转发到3001）
netsh interface portproxy delete v4tov4 listenport=443 listenaddress=0.0.0.0
netsh interface portproxy add v4tov4 listenport=443 listenaddress=0.0.0.0 connectport=3001 connectaddress=127.0.0.1

# 更新端口转发启动脚本
@"
@echo off
netsh interface portproxy delete v4tov4 listenport=80 listenaddress=0.0.0.0
netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=3000 connectaddress=127.0.0.1
netsh interface portproxy delete v4tov4 listenport=443 listenaddress=0.0.0.0
netsh interface portproxy add v4tov4 listenport=443 listenaddress=0.0.0.0 connectport=3001 connectaddress=127.0.0.1
"@ | Out-File -FilePath "C:\websites\jujhub\portproxy-setup.bat" -Encoding ascii -Force
```

### HTTPS文件说明

1. **https-server.js**：
   - 创建HTTPS服务器，监听3001端口
   - 自动加载SSL证书
   - 处理所有HTTPS请求

2. **http-server.js**：
   - 创建HTTP重定向服务器，监听3000端口
   - 将所有HTTP请求重定向到HTTPS

3. **ecosystem-https.config.js**：
   - PM2配置文件，定义两个应用：
     - jujhub-http：HTTP服务（3000端口）
     - jujhub-https：HTTPS服务（3001端口）

4. **setup-https.ps1**：
   - PowerShell脚本，自动配置HTTPS服务
   - 更新端口转发规则
   - 重启PM2服务

## 6. 防火墙配置

```powershell
# 开放80和443端口
New-NetFirewallRule -DisplayName "JuJHub-HTTP" -Direction Inbound -Protocol TCP -LocalPort 80 -Action Allow
New-NetFirewallRule -DisplayName "JuJHub-HTTPS" -Direction Inbound -Protocol TCP -LocalPort 443 -Action Allow
```

## 7. 测试部署

### 本地测试

1. 在服务器上打开浏览器
2. 访问 http://localhost:3000
3. 检查网站是否正常加载

### 远程测试

1. 从外部计算机访问您的网站域名
2. 验证以下项目：
   - 网站是否正常加载
   - HTTPS是否正常工作（浏览器地址栏是否显示锁定图标）
   - 所有图片和资源是否正常显示

## 8. 常见问题

### 问题：无法访问网站

**解决方案:**

1. 检查Node.js应用是否正在运行
   ```powershell
   pm2 list
   ```
   如果没有应用运行，手动启动：
   ```powershell
   cd C:\websites\jujhub\JuJ-Hub
   pm2 start ecosystem.config.js
   ```

2. 检查端口转发规则
   ```powershell
   netsh interface portproxy show all
   ```
   如果没有规则，重新配置：
   ```powershell
   netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=3000 connectaddress=127.0.0.1
   ```

3. 检查80端口是否被占用
   ```powershell
   netstat -ano | findstr ":80"
   ```
   如果被占用（通常是IIS），尝试停止IIS：
   ```powershell
   iisreset /stop
   ```

### 问题：服务器重启后网站无法访问

**解决方案:**

1. 检查PM2是否自动启动
   ```powershell
   pm2 list
   ```
   如果没有应用运行，手动启动：
   ```powershell
   cd C:\websites\jujhub\JuJ-Hub
   pm2 start ecosystem.config.js
   ```

2. 检查端口转发规则是否生效
   ```powershell
   netsh interface portproxy show all
   ```
   如果没有规则，手动添加：
   ```powershell
   netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=3000 connectaddress=127.0.0.1
   ```

3. 检查计划任务是否正确配置
   - 打开"任务计划程序"
   - 检查"PM2-JuJHub"和"PortProxy-JuJHub"任务是否存在并启用 